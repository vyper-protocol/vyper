<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>initialize - Vyper Core Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../architecture.html"><strong aria-hidden="true">3.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../lifecycle.html"><strong aria-hidden="true">4.</strong> Lifecycle</a></li><li class="chapter-item expanded "><a href="../../vyper_core_program/overview.html"><strong aria-hidden="true">5.</strong> Vyper Core Program</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vyper_core_program/accounts/overview.html"><strong aria-hidden="true">5.1.</strong> Accounts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vyper_core_program/accounts/tranche_configuration.html"><strong aria-hidden="true">5.1.1.</strong> Tranche Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../../vyper_core_program/instructions/overview.html"><strong aria-hidden="true">5.2.</strong> Instructions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vyper_core_program/instructions/initialize.html" class="active"><strong aria-hidden="true">5.2.1.</strong> initialize</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.2.</strong> deposit</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.3.</strong> redeem</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.4.</strong> refresh_tranche_fair_value</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.5.</strong> update_tranche_data</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.6.</strong> collect_fee</div></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../plugins/overview.html"><strong aria-hidden="true">6.</strong> Plugins</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../plugins/rate/overview.html"><strong aria-hidden="true">6.1.</strong> Rate Plugins</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../plugins/rate/switchboard.html"><strong aria-hidden="true">6.1.1.</strong> Rate Switchboard</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.2.</strong> Rate Pyth</div></li><li class="chapter-item expanded "><a href="../../plugins/rate/poolv2.html"><strong aria-hidden="true">6.1.3.</strong> Rate PoolV2</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.4.</strong> Rate Mock</div></li></ol></li><li class="chapter-item expanded "><a href="../../plugins/redeem_logic/overview.html"><strong aria-hidden="true">6.2.</strong> Redeem Logic Plugins</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.1.</strong> Redeem Logic Farming</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.2.</strong> Redeem Logic Fila</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.3.</strong> Redeem Logic Forward</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.4.</strong> Redeem Logic Lending</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.5.</strong> Redeem Logic Lending Fee</div></li><li class="chapter-item expanded "><a href="../../plugins/redeem_logic/vanilla_option.html"><strong aria-hidden="true">6.2.6.</strong> Redeem Logic Vanilla Option</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Applications</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">7.1.</strong> Vyper Vaults</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> Vyper OTC</div></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../appendix/rust_decimal_representation.html">Appendix: Rust Decimal Representation</a></li><li class="chapter-item expanded affix "><a href="../../misc/libraries.html">Used Libraries</a></li><li class="chapter-item expanded affix "><a href="../../misc/contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Vyper Core Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="initialize"><a class="header" href="#initialize">initialize</a></h1>
<p>During the initialization we ned to define all the parameters that we're going to use in a vyper tranche configuration and the accounts involved. Vyper during this instruction will crate also the two mints for the senior side tokens and the junior side tokens, for both of them the mint authority is the program itself.</p>
<h2 id="input-data"><a class="header" href="#input-data">Input data</a></h2>
<p>The inputs provided by the caller for the initialization are define with the following struct:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(AnchorDeserialize, AnchorSerialize, Clone, Copy, Debug)]
pub struct InitializeInput {
    pub tranche_mint_decimals: u8,
    pub halt_flags: u16,
    pub owner_restricted_ixs: u16,
}
<span class="boring">}
</span></code></pre></pre>
<p>Where:</p>
<ul>
<li><code>tranche_mint_decimals</code>: the decimals places used for both senior and junior tranches</li>
<li><code>halt_flags</code>: bitmask with the halted operations, once initialized only the owner of the tranche configuration will be capable of changing it</li>
<li><code>owner_restricted_ixs</code>: bitmask with the ixs restricted to the owner, for these instructions the owner will need to be the tx signer</li>
</ul>
<p>At the time of writing the two bitmasks have the following values:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>bitflags::bitflags! {
    pub struct TrancheHaltFlags: u16 {
        /// Disable deposits
        const HALT_DEPOSITS = 1 &lt;&lt; 0;

        /// Disable refreshes
        const HALT_REFRESHES = 1 &lt;&lt; 1;

        /// Disable redeems
        const HALT_REDEEMS = 1 &lt;&lt; 2;

        /// Disable all operations
        const HALT_ALL = Self::HALT_DEPOSITS.bits
                       | Self::HALT_REFRESHES.bits
                       | Self::HALT_REDEEMS.bits;

    }
}

bitflags::bitflags! {
    pub struct OwnerRestrictedIxFlags: u16 {
        /// Owner restricted: Deposits
        const DEPOSITS = 1 &lt;&lt; 0;

        /// Owner restricted: Refreshes
        const REFRESHES = 1 &lt;&lt; 1;

        /// Owner restricted: Redeems
        const REDEEMS = 1 &lt;&lt; 2;

        /// Disable all operations
        const ALL = Self::DEPOSITS.bits
                       | Self::REFRESHES.bits
                       | Self::REDEEMS.bits;

    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="accounts"><a class="header" href="#accounts">Accounts</a></h2>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Accounts)]
#[instruction(input_data: InitializeInput)]
pub struct InitializeContext&lt;'info&gt; {
    /// Signer account
    #[account(mut)]
    pub payer: Signer&lt;'info&gt;,

    /// CHECK: Owner of the tranche config
    #[account()]
    pub owner: AccountInfo&lt;'info&gt;,

    /// Tranche config account, where all the parameters are saved
    #[account(init, payer = payer, space = TrancheConfig::LEN)]
    pub tranche_config: Box&lt;Account&lt;'info, TrancheConfig&gt;&gt;,

    /// CHECK:
    #[account(seeds = [tranche_config.key().as_ref(), b&quot;authority&quot;.as_ref()], bump)]
    pub tranche_authority: AccountInfo&lt;'info&gt;,

    /// CHECK:
    #[account()]
    pub rate_program: AccountInfo&lt;'info&gt;,

    /// CHECK:
    #[account()]
    pub rate_program_state: AccountInfo&lt;'info&gt;,

    /// CHECK:
    #[account()]
    pub redeem_logic_program: AccountInfo&lt;'info&gt;,

    /// CHECK:
    #[account()]
    pub redeem_logic_program_state: AccountInfo&lt;'info&gt;,

    /// LP mint token to deposit
    #[account()]
    pub reserve_mint: Box&lt;Account&lt;'info, Mint&gt;&gt;,

    /// Token account for vault reserve tokens
    #[account(init, payer = payer, seeds = [tranche_config.key().as_ref(), reserve_mint.key().as_ref()], bump, token::authority = tranche_authority, token::mint = reserve_mint)]
    pub reserve: Box&lt;Account&lt;'info, TokenAccount&gt;&gt;,

    /// Senior tranche mint
    #[account(init, payer = payer, mint::decimals = input_data.tranche_mint_decimals, mint::authority = tranche_authority)]
    pub senior_tranche_mint: Box&lt;Account&lt;'info, Mint&gt;&gt;,

    /// Junior tranche mint
    #[account(init, payer = payer, mint::decimals = input_data.tranche_mint_decimals, mint::authority = tranche_authority)]
    pub junior_tranche_mint: Box&lt;Account&lt;'info, Mint&gt;&gt;,

    pub system_program: Program&lt;'info, System&gt;,
    pub token_program: Program&lt;'info, Token&gt;,
    pub rent: Sysvar&lt;'info, Rent&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>Noteworthy accounts are:</p>
<ul>
<li><code>tranche_config</code>: the account created to store the state of the tranche configuration</li>
<li><code>tranche_authority</code>: the PDA account used to sign instructions</li>
<li><code>rate_program</code> and <code>rate_program_state</code>: the rate plugin and the its state, those accounts are saved in the tranche configuration in order avoid hack involving different plugins</li>
<li><code>redeem_logic_program</code> and <code>redeem_logic_program_state</code>: same as before for the redeem logic plugin</li>
<li><code>reserve_mint</code> and <code>reserve</code>: the underlying asset swapped for tranche positions and its token account, the latter owned by the program</li>
<li><code>senior_tranche_mint</code> and <code>junior_tranche_mint</code>: the two mints created for senior and junior positions</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../vyper_core_program/instructions/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../plugins/overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../vyper_core_program/instructions/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../plugins/overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
